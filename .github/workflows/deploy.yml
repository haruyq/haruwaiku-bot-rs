name: Auto Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: First Notify Discord
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{"content":"üìê `[DEPLOY]` haruwaiku-bot-rs New commit Detected. Service will be reload."}' \
            "${{ secrets.DISCORD_WEBHOOK }}"
            
      - name: Remote Deploy
        run: |
          sshpass -p "${{ secrets.SERVER_PASS }}" ssh -p 2222 -o StrictHostKeyChecking=no \
            ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e
          cd ~/haruwaiku-bot-rs
          git pull https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/haruyq/haruwaiku-bot-rs.git master
          echo "${{ secrets.DEPLOY }}" > .env
          docker compose pull
          docker compose up -d --remove-orphans
          EOF

      - name: Last Notify Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{"content":"‚úÖ `[OK]` haruwaiku-bot-rs Service is up!"}' \
            "${{ secrets.DISCORD_WEBHOOK }}"

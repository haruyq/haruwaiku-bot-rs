name: Auto Deploy

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Remote Deploy via HTTPS (no SSH)
        run: |
          sshpass -p "${{ secrets.SERVER_PASS }}" ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e
          cd ~/haruwaiku-bot-rs
          git pull https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/haruyq/haruwaiku-bot-rs.git master
          echo "${{ secrets.DEPLOY }}" > .env
          docker compose pull
          docker compose up -d --remove-orphans
          EOF

      - name: Notify Discord
        if: success()
        run: |
          curl -H "Content-Type: application/json" \
            -X POST \
            -d '{"content":"âœ… `[200 | OK]` haruwaiku-bot-rs has been deployed (no SSH)."}' \
            "${{ secrets.DISCORD_WEBHOOK }}"
